= apply-config.sh

// +-----------------------------------------------+
// |                                               |
// |    DO NOT EDIT HERE !!!!!                     |
// |                                               |
// |    File is auto-generated by pipline.         |
// |    Contents are based on bash script docs.    |
// |                                               |
// +-----------------------------------------------+


Apply a consistent configuration for all (relevant) Github repositories.

== Overview

This script applies a consistent configuration across all
link:https://github.com/sebastian-sommerfeld-io?tab=repositories[Github repositories]. using
Terraform. The link:https://registry.terraform.io/providers/integrations/github/latest/docs[Terraform Github Provider]
allows interaction with Github.

Terraform is started inside a link:https://www.docker.com/[Docker] container, so there is no need
to install Terraform or any other software other than Docker on your machine.

Terraform is an open-source infrastructure as code software tool that enables you to safely and
predictably create, change, and improve infrastructure. It provides infrastructure automation with
workflows to build composition, collaboration, and reuse of infrastructure as code.

Github Actions workflow: # link:https://github.com/sebastian-sommerfeld-io/configs/actions/workflows/configure-github.yml[Apply global Github config]

.Available Terraform commands
include::ROOT:partial$GENERATED/github/config/help.adoc[]

Use `xref:AUTO-GENERATED:bash-docs/src/main/github/run-local-sh.adoc[run-local.sh]` while developing
on your localhost instead of direct calls to this script. `run-local.sh` provides a more conviniert
way to trigger the terraform commands.

=== Script Arguments

* _$1_ (string): The `terraform` command to run - _Mandatory_
* _$2_ (string): Github token ... when running on localhost pass a token from anywhere, when running in a Github Actions workflow pass `${{ secrets.GITHUB_TOKEN }}` - _Mandatory for `plan` and `apply`_
* _$3_ (string): Bitwarden client id ... when running on localhost pass a data from anywhere, when running in a Github Actions workflow pass the correct Actions secret - _Mandatory for `plan` and `apply`_
* _$4_ (string): Bitwarden client secret ... when running on localhost pass a data from anywhere, when running in a Github Actions workflow pass the correct Actions secret - _Mandatory for `plan` and `apply`_
* _$5_ (string): Bitwarden master password ... when running on localhost pass a data from anywhere, when running in a Github Actions workflow pass the correct Actions secret - _Mandatory for `plan` and `apply`_

=== Script Example

To run this script locally, run the commands in the same order as the pipeline does (see docs for
each function). Running this script without arguments will result in an error.

[source, bash]

----
./apply-config.sh init
./apply-config.sh lint
./apply-config.sh validate
./apply-config.sh fmt
./apply-config.sh plan "$TOKEN" "$BW_CLIENT_ID" "$BW_CLIENT_SECRET" "$BW_MASTER_PASS"
./apply-config.sh apply "$TOKEN" "$BW_CLIENT_ID" "$BW_CLIENT_SECRET" "$BW_MASTER_PASS"
./apply-config.sh docs
./apply-config.sh cleanup
----

== Index

* <<_terraform,terraform>>
* <<_apply,apply>>
* <<_cleanup,cleanup>>
* <<_docs,docs>>
* <<_format,format>>
* <<_initialize,initialize>>
* <<_lint,lint>>
* <<_plan,plan>>
* <<_validate,validate>>
* <<_version,version>>

=== terraform

Wrapper function to encapsulate terraform in a docker container. The current working
directory is mounted into the container and selected as working directory so that all file are
available to terraform. Paths are preserved. The container runs with the current user.

==== Example

[,bash]
----
terraform -version
----

==== Arguments

* *...* (String): The terraform commands (1-n arguments) - $1 is mandatory

==== Exit codes

* *8*: If param with terraform command is missing

=== apply

Apply this configuration by running `terraform apply -auto-approve`. After
applying the configuration the `terraform.state` file is copied back to the local clone of the
link:https://github.com/sebastian-sommerfeld-io/configs-persistent-data[configs-persistent-data]
repository. This updated is committed and pushed back to the remote repository.

Pipeline Step 7.

==== Example

[,bash]
----
apply
----

=== cleanup

Remove all temporary files. When running in a pipeline, this step is always invoked.

Pipeline Step 9.

==== Example

[,bash]
----
apply
----

=== docs

Generate documentation about this terraform configuratio by running
link:https://github.com/terraform-docs/terraform-docs[terraform-docs] inside a Docker container.
The generated docs are stored as an Antora partials file.

Pipeline Step 8.

==== Example

[,bash]
----
validate
----

=== format

Apply consistent format to all .tf files by running `terraform fmt -recursive`.

Pipeline Step 5.

==== Example

[,bash]
----
fmt
----

=== initialize

Initialize this configuration by running `terraform init`.

_When running on a local machine during development:_ Before running `terraform init` the
link:https://github.com/sebastian-sommerfeld-io/configs-persistent-data[configs-persistent-data]
repo is cloned and the terraform state is copied to its correct location. This is done to
use terraform as it is intended. Without a state, terraform assumes that every config must
be applied (which mostly is not necessary). Terraform sould only apply the settings that
don't match the defintion.

Pipeline Step 2.

==== Example

[,bash]
----
initialize
----

=== lint

Use link:https://github.com/terraform-linters/tflint[terraform-linters/tflint] linter
to check terraform config (specifically
link:https://github.com/terraform-linters/tflint-bundle[terraform-linters/tflint-bundle]).

Pipeline Step 3.

==== Example

[,bash]
----
lint
----

=== plan

Plan this configuration by running `terraform plan`.

Pipeline Step 6.

==== Example

[,bash]
----
plan
----

=== validate

Validate Terraform configuration by running `terraform validate`.

Pipeline Step 4.

==== Example

[,bash]
----
validate
----

=== version

Show Terraform version by running `terraform -version`.

Pipeline Step 1.

==== Example

[,bash]
----
version
----
